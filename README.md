# 항해 플러스 백엔드 코스 1주차 과제

## 1. 요구사항
<details>  
<summary>열기</summary>
### STEP01 `기본과제`

- 포인트 충전, 사용에 대한 정책 추가 (잔고 부족, 최대 잔고 등)
- 동시에 여러 요청이 들어오더라도 순서대로 (혹은 한번에 하나의 요청씩만) 제어될 수 있도록 리팩토링
- 동시성 제어에 대한 통합 테스트 작성

### STEP02 `심화과제`

- 동시성 제어 방식에 대한 분석 및 보고서 작성 ( **README.md** )

### ❓ [과제] `point` 패키지의 TODO 와 테스트코드를 작성해주세요.

**요구 사항**

- PATCH  `/point/{id}/charge` : 포인트를 충전한다.
- PATCH `/point/{id}/use` : 포인트를 사용한다.
- *GET `/point/{id}` : 포인트를 조회한다.*
- *GET `/point/{id}/histories` : 포인트 내역을 조회한다.*
- *잔고가 부족할 경우, 포인트 사용은 실패하여야 합니다.*
- *동시에 여러 건의 포인트 충전, 이용 요청이 들어올 경우 순차적으로 처리되어야 합니다.*
</details>

## 2. 동시성 제어 방식에 대한 분석 및 보고서

### A. 동시성 문제란 무엇인가?
 - 동시성 문제는 **여러 프로세스나 스레드가 동시에 자원에 접근하거나 작업을 수행**할 때 발생할 수 있는 예기치 않은 문제이다.

### B. 동시성 제어는 어떻게 할 수 있는가?
- 동시성 문제는 크게 Application 단에서 관리하는 방식과 Database 에서 관리하는 방식으로 제어할 수 있다.
- 데이터베이스에서의 동시성 제어는 트랜잭션 관리를 통해 데이터 무결성과 일관성을 보장하며, 잠금(lock), 격리 수준(isolation level)을 사용한다.
- 애플리케이션에서의 동시성 제어는 멀티 쓰레드 환경에서 여러 쓰레드가 동시에 자원에 접근할 때 발생하는 문제를 방지하며, 잠금(lock), 동기화(Synchronization), CAS 알고리즘을 사용한다.

### C. 해당 과제에서 동시성 제어는 어떻게 접근할 수 있을까?
- 작성하고 있는 Kotlin / Spring Boot 코드는 JVM 환경에서, 그리고 Application 단에서 동시성 문제를 바라봐야 한다.
- Spring Boot 는 Client의 요청마다 Thread 를 할당하며, 이 Thread는 JVM 메모리 영역 중 HEAP, CODE, DATA를 공유한다. 
- 먼저 동시성 문제가 발생할 수 있는 "자원"은 아래와 같으며, 각 데이터 타입은 모두 Thread-Safe 하지 않다.
  - UserPointTable 의 table : HashMap<Long, UserPoint>
  - PointHistoryTable 의 table : MutableList<PointHistory>
  - PointHistoryTable 의 cursor : Long
- 따라서 동시성 문제는 아래와 같은 상황에서 발생할 수 있다.
  - 포인트 충전 또는 사용이 이루어질 때, 각기 다른 쓰레드가 기존 포인트를 조회하고 포인트를 변경하는 경우
- 이에 대해 Lock 을 걸어 하나의 쓰레드만 특정 자원에 접근하는 방식으로 위와 같은 문제를 제어할 수 있다. 

## 3. 회고
